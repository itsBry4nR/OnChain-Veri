name: Matrix Data Fetcher

on:
  schedule:
    - cron: '0 0 * * *' # Her gece çalış (UTC 00:00)
  workflow_dispatch:      # Manuel tetiklemek için buton

jobs:
  # 1. AŞAMA: PARALEL AJANLAR (Veri Çekme)
  fetch-shards:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 6'ya böldüğümüz için 0'dan 5'e kadar sayı veriyoruz.
        # Eğer "fetch-data.js" içinde "--total 10" yaparsan burayı da 0..9 yapmalısın.
        group: [0, 1, 2, 3, 4, 5] 
    
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18
        
    - name: Parça İndir
      # Scripti ilgili grup numarasıyla çalıştır
      run: node scripts/fetch-data.js --group ${{ matrix.group }} --total 6
      
    - name: Parçayı Yükle (Artifact)
      uses: actions/upload-artifact@v3
      with:
        name: data-shard-${{ matrix.group }}
        path: data/shard-${{ matrix.group }}.json
        retention-days: 1

  # 2. AŞAMA: BİRLEŞTİRME (Merge)
  combine-and-push:
    needs: fetch-shards  # Ajanlar bitmeden başlama
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18
        
    # Tüm parçaları indir
    - name: Tüm Parçaları İndir
      uses: actions/download-artifact@v3
      with:
        path: data-temp
        
    # İndirilen dosyaları doğru yere taşı
    - name: Dosyaları Taşı
      run: |
        mkdir -p data
        mv data-temp/data-shard-*/*.json data/
        
    # Birleştirici scripti çalıştır
    - name: JSON Birleştir
      run: node scripts/fetch-data.js --merge
      
    # GitHub'a geri yükle
    - name: Commit & Push
      run: |
        git config --global user.name 'Matrix Bot'
        git config --global user.email 'bot@noreply.github.com'
        git add data/all-metrics.json
        # Sadece değişiklik varsa commit at
        git diff --quiet && git diff --staged --quiet || (git commit -m "Günlük Veri (Matrix): $(date)" && git push)

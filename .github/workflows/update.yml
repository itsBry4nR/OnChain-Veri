name: Matrix Data Fetcher

on:
  schedule:
    - cron: '0 4 * * *' # UTC 04:00'te çalışacak
  workflow_dispatch:      # Manuel tetikleme butonu

jobs:
  # 1. AŞAMA: PARALEL AJANLAR (Veri Çekme)
  fetch-shards:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 6 Makine çalıştırıyoruz (0'dan 5'e kadar)
        group: [0, 1, 2, 3, 4] 
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        
    - name: Parça İndir
      # Scripti ilgili grup numarasıyla çalıştır
      run: node scripts/fetch-data.js --group ${{ matrix.group }} --total 5
      
    - name: Parçayı Yükle (Artifact)
      uses: actions/upload-artifact@v4  # GÜNCELLENDİ: v4
      with:
        name: data-shard-${{ matrix.group }}
        path: data/shard-${{ matrix.group }}.json
        retention-days: 1

  # 2. AŞAMA: BİRLEŞTİRME (Merge)
  combine-and-push:
    needs: fetch-shards  # Ajanlar bitmeden başlama
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # Repoya yazma izni ver

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        
    # Tüm parçaları indir (v4 ile tüm artifact'leri çeker)
    - name: Tüm Parçaları İndir
      uses: actions/download-artifact@v4 # GÜNCELLENDİ: v4
      with:
        path: data-temp
        
    # İndirilen dosyaları doğru yere taşı
    # v4, her artifact'i kendi klasörüne koyar: data-temp/data-shard-0/shard-0.json
    - name: Dosyaları Taşı
      run: |
        mkdir -p data
        # data-temp altındaki tüm alt klasörlerdeki json'ları data'ya taşı
        find data-temp -name "shard-*.json" -exec mv {} data/ \;
        
    # Birleştirici scripti çalıştır
    - name: JSON Birleştir
      run: node scripts/fetch-data.js --merge
      
    # GitHub'a geri yükle
    - name: Commit & Push
      run: |
        git config --global user.name 'Matrix Bot'
        git config --global user.email 'bot@noreply.github.com'
        git add data/all-metrics.json
        # Sadece değişiklik varsa commit at
        git diff --quiet && git diff --staged --quiet || (git commit -m "Günlük Veri (Matrix): $(date)" && git push)

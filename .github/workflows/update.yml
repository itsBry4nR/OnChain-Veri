name: Matrix Data Fetcher

on:
  schedule:
    - cron: '0 4 * * *' # Her gece UTC 04:00 (TSİ 07:00)'de çalış
  workflow_dispatch:      # Manuel tetikleme butonu

jobs:
  # 1. AŞAMA: PARALEL AJANLAR
  fetch-shards:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Şimdilik sadece 3 verimiz var, 1 makine (Grup 0) hepsini halleder.
        # İleride veri artarsa burayı [0, 1, 2...] diye çoğaltırsın.
        group: [0] 
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        
    - name: Parça İndir
      # DİKKAT: --total 1 yaptık çünkü tek makine çalışıyor.
      run: node scripts/fetch-data.js --group ${{ matrix.group }} --total 1
      
    - name: Parçayı Yükle (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: data-shard-${{ matrix.group }}
        path: data/shard-${{ matrix.group }}.json
        retention-days: 1

  # 2. AŞAMA: BİRLEŞTİRME (Merge)
  combine-and-push:
    needs: fetch-shards
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # Repoya yazma izni

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        
    - name: Tüm Parçaları İndir
      uses: actions/download-artifact@v4
      with:
        path: data-temp
        
    # İndirilen dosyaları (data-temp içinden) ana data klasörüne taşı
    - name: Dosyaları Taşı
      run: |
        mkdir -p data
        find data-temp -name "shard-*.json" -exec mv {} data/ \;
        
    - name: JSON Birleştir
      run: node scripts/fetch-data.js --merge
      
    - name: Commit & Push
      run: |
        git config --global user.name 'Matrix Bot'
        git config --global user.email 'bot@noreply.github.com'
        git add data/all-metrics.json
        # Değişiklik varsa kaydet, yoksa hata verme
        git diff --quiet && git diff --staged --quiet || (git commit -m "Günlük Veri (Matrix): $(date)" && git push)
